services:
  # Redis - Message broker for async processing
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # API Gateway - Entry point for all requests
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    ports:
      - "5000:5000"
    environment:
      - IMPORT_SERVICE_URL=http://import-service:5001
      - METADATA_SERVICE_URL=http://metadata-service:5002
      - STORAGE_SERVICE_URL=http://storage-service:5003
      - WORKER_SERVICE_URL=http://worker-service:5004
    depends_on:
      - import-service
      - metadata-service
      - storage-service
      - worker-service
    networks:
      - microservices-network
    restart: unless-stopped

  # Import Service - Handles Google Drive imports
  import-service:
    build:
      context: ./services/import-service
      dockerfile: Dockerfile
    ports:
      - "5001:5001"
    environment:
      - REDIS_URL=redis://redis:6379/0
      - WORKER_SERVICE_URL=http://worker-service:5004
      - GOOGLE_API_KEY=AIzaSyDqBiHSCru_c1RrgIxP5rTSznv8JKespqU
    depends_on:
      - redis
    networks:
      - microservices-network
    restart: unless-stopped

  # Metadata Service - Database operations
  metadata-service:
    build:
      context: ./services/metadata-service
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    environment:
      # Azure SQL Database Configuration
      - DB_SERVER=image-import-sql-server.database.windows.net
      - DB_NAME=image_metadata_db
      - DB_USER=sqladmin
      - DB_PASSWORD=Yash@sql
      - DB_DRIVER=ODBC Driver 18 for SQL Server
    volumes:
      - metadata-data:/app/instance
    networks:
      - microservices-network
    restart: unless-stopped

  # Storage Service - Cloud storage operations
  storage-service:
    build:
      context: ./services/storage-service
      dockerfile: Dockerfile
    ports:
      - "5003:5003"
    environment:
      - STORAGE_PROVIDER=${STORAGE_PROVIDER:-azure}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_BUCKET_NAME=${AWS_BUCKET_NAME}
      - AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=imagestorage2;AccountKey=skDEfA5x7zN+q9l85Kvb4x00TcreNGwbd6rLHHyTrb2ZdUBE9xL5FIUgqYbdnPC9oIgKjjiIoXLq+AStHXrpAA==;EndpointSuffix=core.windows.net
      - AZURE_STORAGE_CONTAINER_NAME=images
    networks:
      - microservices-network
    restart: unless-stopped

  # Worker Service - Async image processing
  worker-service:
    build:
      context: ./services/worker-service
      dockerfile: Dockerfile
    environment:
      - STORAGE_SERVICE_URL=http://storage-service:5003
      - METADATA_SERVICE_URL=http://metadata-service:5002
      - IMPORT_SERVICE_URL=http://import-service:5001
      - GOOGLE_API_KEY=AIzaSyDqBiHSCru_c1RrgIxP5rTSznv8JKespqU
      - STORAGE_PROVIDER=azure
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
      - storage-service
      - metadata-service
    networks:
      - microservices-network
    restart: unless-stopped
    deploy:
      replicas: 3  # Scale workers for high throughput

  # Frontend - React application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    environment:
      - REACT_APP_API_URL=http://localhost:5000/api
    depends_on:
      - api-gateway
    networks:
      - microservices-network
    restart: unless-stopped


volumes:
  redis-data:
    driver: local
  metadata-data:
    driver: local

networks:
  microservices-network:
    driver: bridge
